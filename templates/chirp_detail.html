{% extends "base.html" %} {% block title %}Chirp - ChirpX{% endblock %} {% block
content %}
<div class="max-w-3xl mx-auto">
  <!-- Back Button -->
  <div class="mb-6">
    <a
      href="{{ url_for('timeline') }}"
      class="inline-flex items-center gap-2 px-4 py-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-700 transition-colors"
    >
      <i class="fas fa-arrow-left"></i>
      <span>Back to Timeline</span>
    </a>
  </div>

  <!-- Main Chirp Card -->
  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 mb-6"
  >
    <div class="p-6">
      <!-- Author Info -->
      <div class="flex items-start gap-4 mb-4">
        <a
          href="{{ url_for('profile', username=chirp['username']) }}"
          class="flex-shrink-0"
        >
          {% if chirp['profile_picture'] %}
          <img
            src="{{ url_for('static', filename=chirp['profile_picture']) }}"
            alt="{{ chirp['username'] }}"
            class="w-16 h-16 rounded-full object-cover border-2 border-gray-200 dark:border-gray-700"
          />
          {% else %}
          <div
            class="w-16 h-16 rounded-full bg-gradient-to-br from-primary-500 to-purple-500 flex items-center justify-center text-white font-bold text-2xl border-2 border-gray-200 dark:border-gray-700"
          >
            {{ chirp['username'][0].upper() }}
          </div>
          {% endif %}
        </a>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <a
              href="{{ url_for('profile', username=chirp['username']) }}"
              class="font-bold text-gray-900 dark:text-white hover:underline"
            >
              {{ chirp['full_name'] or chirp['username'] }}
            </a>
            <span class="text-gray-500 dark:text-gray-400"
              >@{{ chirp['username'] }}</span
            >
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            {{ chirp['created_at'] }}
          </p>
        </div>
      </div>

      <!-- Chirp Content -->
      <div class="text-xl text-gray-900 dark:text-white mb-6 leading-relaxed">
        {{ chirp['content'] }}
      </div>

      <!-- AI Sentiment Analysis -->
      <div
        class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg p-4 mb-6 text-white"
      >
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <i class="fas fa-brain"></i>
            <span class="font-semibold">AI Sentiment Analysis</span>
          </div>
          <button
            onclick="loadSentiment({{ chirp['id'] }})"
            class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors backdrop-blur-sm"
          >
            <i class="fas fa-sync mr-1"></i>Analyze
          </button>
        </div>
        <div
          id="sentiment-content-{{ chirp['id'] }}"
          class="text-sm opacity-90"
        >
          Click analyze to view sentiment, emotions, and hashtag suggestions
        </div>
      </div>

      <!-- Stats Bar -->
      <div
        class="flex items-center gap-8 py-4 border-y border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-400"
      >
        <div>
          <span class="font-bold text-gray-900 dark:text-white"
            >{{ chirp['like_count'] }}</span
          >
          <span class="ml-1">Likes</span>
        </div>
        <div>
          <span class="font-bold text-gray-900 dark:text-white"
            >{{ chirp['comment_count'] }}</span
          >
          <span class="ml-1">Comments</span>
        </div>
        <div>
          <span class="font-bold text-gray-900 dark:text-white"
            >{{ chirp['retweet_count'] }}</span
          >
          <span class="ml-1">Retweets</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center gap-4 pt-4">
        <form
          method="POST"
          action="{{ url_for('like_chirp', chirp_id=chirp['id']) }}"
          class="flex-1"
        >
          <button
            type="submit"
            class="flex items-center justify-center gap-2 w-full py-3 rounded-lg transition-colors {% if chirp['user_liked'] %}text-red-500 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30{% else %}text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}"
          >
            <i class="fas fa-heart"></i>
            <span>Like</span>
          </button>
        </form>

        <form
          method="POST"
          action="{{ url_for('retweet_chirp', chirp_id=chirp['id']) }}"
          class="flex-1"
        >
          <button
            type="submit"
            class="flex items-center justify-center gap-2 w-full py-3 rounded-lg transition-colors {% if chirp['user_retweeted'] %}text-green-500 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30{% else %}text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}"
          >
            <i class="fas fa-retweet"></i>
            <span>Retweet</span>
          </button>
        </form>

        {% if chirp['user_id'] == session.user_id %}
        <form
          method="POST"
          action="{{ url_for('delete_chirp', chirp_id=chirp['id']) }}"
          onsubmit="return confirm('Are you sure you want to delete this chirp?')"
        >
          <button
            type="submit"
            class="px-4 py-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
          >
            <i class="fas fa-trash"></i>
          </button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Add Comment Section -->
  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 mb-6 p-6"
  >
    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
      Add a Comment
    </h2>
    <form
      method="POST"
      action="{{ url_for('add_comment', chirp_id=chirp['id']) }}"
    >
      <div class="mb-3">
        <textarea
          id="comment-content"
          name="content"
          rows="3"
          maxlength="280"
          required
          placeholder="Write your comment..."
          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"
        ></textarea>
        <div
          id="comment-char-counter"
          class="text-right text-sm text-gray-500 dark:text-gray-400 mt-1"
        >
          0/280
        </div>
      </div>
      <button
        type="submit"
        class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors"
      >
        <i class="fas fa-comment mr-2"></i>Post Comment
      </button>
    </form>
  </div>

  <!-- Comments Section -->
  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700"
  >
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white">
        Comments
        <span class="text-gray-500 dark:text-gray-400"
          >({{ comments|length }})</span
        >
      </h2>
    </div>

    {% if comments %}
    <div class="divide-y divide-gray-200 dark:divide-gray-700">
      {% for comment in comments %}
      <div
        class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
      >
        <div class="flex gap-4">
          <a
            href="{{ url_for('profile', username=comment['username']) }}"
            class="flex-shrink-0"
          >
            {% if comment['profile_picture'] %}
            <img
              src="{{ url_for('static', filename=comment['profile_picture']) }}"
              alt="{{ comment['username'] }}"
              class="w-12 h-12 rounded-full object-cover"
            />
            {% else %}
            <div
              class="w-12 h-12 rounded-full bg-gradient-to-br from-primary-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg"
            >
              {{ comment['username'][0].upper() }}
            </div>
            {% endif %}
          </a>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap mb-1">
              <a
                href="{{ url_for('profile', username=comment['username']) }}"
                class="font-semibold text-gray-900 dark:text-white hover:underline"
              >
                {{ comment['full_name'] or comment['username'] }}
              </a>
              <span class="text-gray-500 dark:text-gray-400 text-sm"
                >@{{ comment['username'] }}</span
              >
              <span class="text-gray-400 dark:text-gray-500 text-sm">Â·</span>
              <span class="text-gray-500 dark:text-gray-400 text-sm"
                >{{ comment['created_at'] }}</span
              >
            </div>
            <p class="text-gray-900 dark:text-white mb-2">
              {{ comment['content'] }}
            </p>
            {% if comment['user_id'] == session.user_id %}
            <form
              method="POST"
              action="{{ url_for('delete_comment', comment_id=comment['id']) }}"
              onsubmit="return confirm('Delete this comment?')"
            >
              <button
                type="submit"
                class="text-sm text-red-600 dark:text-red-400 hover:underline"
              >
                <i class="fas fa-trash mr-1"></i>Delete
              </button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="p-12 text-center">
      <div
        class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 dark:bg-blue-900/30 mb-4"
      >
        <i
          class="fas fa-comment-slash text-2xl text-blue-600 dark:text-blue-400"
        ></i>
      </div>
      <p class="text-gray-600 dark:text-gray-400 text-lg">
        No comments yet. Be the first to comment!
      </p>
    </div>
    {% endif %}
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const commentTextarea = document.getElementById("comment-content");
    const commentCounter = document.getElementById("comment-char-counter");

    if (commentTextarea && commentCounter) {
      commentTextarea.addEventListener("input", () => {
        const length = commentTextarea.value.length;
        commentCounter.textContent = `${length}/280`;

        if (length > 260) {
          commentCounter.classList.add(
            "text-yellow-600",
            "dark:text-yellow-400",
            "font-semibold"
          );
          commentCounter.classList.remove(
            "text-gray-500",
            "dark:text-gray-400"
          );
        } else {
          commentCounter.classList.remove(
            "text-yellow-600",
            "dark:text-yellow-400",
            "font-semibold"
          );
          commentCounter.classList.add("text-gray-500", "dark:text-gray-400");
        }
      });
    }

    // Pre-fill with reply suggestion if provided
    const urlParams = new URLSearchParams(window.location.search);
    const reply = urlParams.get("reply");
    if (reply && commentTextarea) {
      commentTextarea.value = reply;
      commentTextarea.dispatchEvent(new Event("input"));
    }
  });

  // Load Sentiment Analysis
  async function loadSentiment(chirpId) {
    const contentDiv = document.getElementById(`sentiment-content-${chirpId}`);
    contentDiv.innerHTML =
      '<span class="inline-flex items-center gap-2"><i class="fas fa-spinner fa-pulse"></i> Analyzing sentiment...</span>';

    try {
      const response = await fetch(`/ai/sentiment/${chirpId}`);
      const data = await response.json();

      let html = '<div class="space-y-2">';

      // Sentiment
      const sentimentIcons = {
        positive: "fa-smile",
        negative: "fa-frown",
        neutral: "fa-meh",
      };

      html += `<div class="flex items-center gap-2">
                        <i class="fas ${sentimentIcons[data.sentiment]}"></i>
                        <span class="font-semibold capitalize">${
                          data.sentiment
                        }</span>
                        <span class="opacity-90">(${Math.round(
                          Math.abs(data.score) * 100
                        )}% confidence)</span>
                     </div>`;

      // Emotions
      if (data.emotions && data.emotions.length > 0) {
        html += '<div class="flex flex-wrap gap-1.5 mt-2">';
        data.emotions.forEach((emotion) => {
          html += `<span class="px-2 py-1 bg-white/20 rounded-md text-xs backdrop-blur-sm">${emotion}</span>`;
        });
        html += "</div>";
      }

      // Hashtags
      if (data.hashtags && data.hashtags.length > 0) {
        html +=
          '<div class="mt-3 pt-3 border-t border-white/20"><div class="text-sm font-semibold mb-1.5">Suggested Hashtags:</div><div class="flex flex-wrap gap-1.5">';
        data.hashtags.forEach((tag) => {
          html += `<span class="px-2 py-1 bg-white/20 rounded-md text-xs backdrop-blur-sm">#${tag}</span>`;
        });
        html += "</div></div>";
      }

      html += "</div>";
      contentDiv.innerHTML = html;
    } catch (error) {
      contentDiv.innerHTML = `<span class="opacity-80">Error loading analysis: ${error.message}</span>`;
    }
  }
</script>
{% endblock %}
